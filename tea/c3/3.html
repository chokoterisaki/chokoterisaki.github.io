<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>C2-3</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link href="../player.css" rel="stylesheet" />
    <style>
      @font-face {
        font-family: "higu"; /*a name to be used later*/
        src: url("assets/std.otf"); /*URL to font*/
      }
      .lol {
        font-family: higu;
      }
    </style>
    <style>
      .book-page {
        max-width: 600px; /* Ancho máximo de la "página" */
        margin: 0 auto; /* Centrar el contenedor */
        padding: 10px;
        text-align: justify; /* Justifica el texto */
        border-radius: 5px; /* Bordes redondeados */
      }
    </style>
  </head>
  <body class="bg-black">
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <main class="text-center top-50">
      <p class="text-white book-page" style="font-family: 'monospace;'">
        Nia logró encontrar el patrón que descifraba el código y se abrió una
        entrada secreta.
      </p>
      <p class="text-white book-page" style="font-family: 'monospace;'">
        Al entrar vimos que era un espacio enorme y vacío, lleno de partes
        mecánicas y monitores que observaban partes de la isla.
      </p>
      <p class="text-white book-page" style="font-family: 'monospace;'">
        Al fondo, se encontraba Aze. Estaba parado en la oscuridad con la forma
        en la que lo recordábamos, como el demonio escarlata.
      </p>
      <p
        class="book-page"
        style="
          font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial,
            sans-serif;
          color: brown;
        "
      >
        "¿Aze, por qué nos llamaste aquí? ¿Por qué nos estas haciendo esto?"
      </p>
      <p class="text-white book-page" style="font-family: 'monospace;'">...</p>
      <p class="text-white book-page" style="font-family: 'monospace;'">
        No respondió nada ni movió ni un solo músculo. Nos percatamos de que no
        podíamos ver su expresión siquiera.
      </p>
      <p class="text-white book-page" style="font-family: 'monospace;'">
        Bauti dió un paso adelante.
      </p>
      <p
        class="book-page"
        style="
          font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS',
            sans-serif;
          color: crimson;
        "
      >
        "Señor Aze, tendré que intervenir yo mismo si no da respuestas."
      </p>
      <p class="text-white book-page" style="font-family: 'monospace;'">
        Tras un breve silencio, se escuchó una risa.
      </p>
      <img class="position-relative" width="512" src="../assets/sdf.jpg" />

      <p class="text-white book-page" style="font-family: 'monospace;'">
        Bauti corrió hasta Aze y lo atravesó con su espada... solo para darse
        cuenta de que Aze ya estaba muerto.
      </p>
      <p class="text-white book-page" style="font-family: 'monospace;'">
        Se fue la luz y se volvió a escuchar una risa.
      </p>
      <footer class="text-center position-relative">
        <div id="SP-tv" class="StarrPlayer">
          <div
            class="SP-track-info"
            style="background-image: url(../mp3/remi.jpg)"
          >
            <div class="SP-track">
              <span class="SP-track-name text-white">???</span>
            </div>
            <div class="SP-artist text-white">
              Original:<span class="SP-artist-name">???</span>
            </div>
            <div class="SP-duration text-white">
              <span class="SP-duration-current"> 0:00 </span>
              <span class="SP-duration-total"> X:XX </span>
            </div>
            <div class="SP-progress-bar">
              <div class="SP-progress-bar-fill">
                <div class="SP-progress-bar-knob"></div>
              </div>
            </div>
          </div>
          <div class="SP-button-row">
            <div class="SP-prev SP-button">&lt;&lt;</div>
            <div class="SP-play SP-button">Play</div>
            <div class="SP-pause SP-button">Pause</div>
            <div class="SP-stop SP-button">Stop</div>
            <div class="SP-next SP-button">&gt;&gt;</div>
          </div>
        </div>
        <script>
          // This component is where the magic happens!
          // You shouldn't need to modify this unless you are adding new features! >🐢
          class MusicPlayer {
            constructor(element, song_data) {
              this.parent_element = element;
              this.audio = null;
              this.current_track_index = -1;
              this.track_element =
                this.parent_element.querySelector(".SP-track-name");
              this.track_scrolling_left = true;
              this.artist_element =
                this.parent_element.querySelector(".SP-artist-name");
              this.artist_scrolling_left = true;
              this.song_data = song_data;
              this.isDragging = false;
              this.start();
            }

            start = () => {
              this.initializeButtons();
              this.initializeStatefulRenderingInterval();
              this.initializeProgressBar();
            };

            initializeStatefulRenderingInterval = () => {
              setInterval(() => {
                this.scrollTrackText();
                this.scrollArtistText();
                this.updateProgressBar(
                  this.getSongProgressPercent(this.audio) * 100
                );
                this.updateProgressText(this.audio);
                this.updateDurationText(this.audio);
                this.renderPauseOrPlayButton();
              }, 50);
            };

            initializeButtons = () => {
              let buttons = this.parent_element.querySelectorAll(".SP-button");
              buttons.forEach((button) => {
                button.addEventListener("click", (event) => {
                  switch (true) {
                    case event.target.classList.contains("SP-play"):
                      this.play_song();
                      break;
                    case event.target.classList.contains("SP-pause"):
                      this.pause_song();
                      break;
                    case event.target.classList.contains("SP-next"):
                      this.next_song();
                      break;
                    case event.target.classList.contains("SP-prev"):
                      this.prev_song();
                      break;
                    case event.target.classList.contains("SP-stop"):
                      this.stop_song();
                      break;
                    default:
                      break;
                  }
                });
              });
            };

            initializeProgressBar = () => {
              let progressKnob = this.parent_element.querySelector(
                ".SP-progress-bar-knob"
              );
              let progressBar =
                this.parent_element.querySelector(".SP-progress-bar");
              progressKnob.addEventListener("pointerdown", (event) => {
                this.isDragging = true;
                event.preventDefault();
              });

              this.parent_element.addEventListener("pointermove", (event) => {
                if (!this.isDragging || !this.audio) return;
                const boundingRect = progressBar.getBoundingClientRect();
                let percent =
                  (event.clientX - boundingRect.left) / boundingRect.width;
                percent = Math.max(0, Math.min(1, percent));
                this.audio.currentTime = this.audio.duration * percent;
                this.updateProgressBar(percent * 100);
              });
              document.addEventListener("pointerup", () => {
                this.isDragging = false;
              });

              progressBar.addEventListener("click", (event) => {
                if (this.audio == null || this.isDragging) return; // Skip if dragging or audio is not initialized
                const bounding = progressBar.getBoundingClientRect();
                const percent =
                  (event.clientX - bounding.left) / bounding.width;
                this.audio.currentTime = this.audio.duration * percent;
                this.updateProgressBar(percent * 100);
              });
            };

            play_song = (track_number) => {
              // If the audio is paused and the track number is the same as the current track, just resume playing
              if (
                this.audio &&
                this.audio.paused &&
                (track_number === this.current_track_index ||
                  track_number == null)
              ) {
                this.audio.play();
                return;
                // If the audio is playing, but the play button is pressed, pause the audio
              } else if (this.audio && track_number == null) {
                this.audio.pause();
                return;
              }
              // Loop the song list if the track number is out of bounds
              if (!track_number && this.current_track_index === -1) {
                track_number = 0;
              } else if (track_number >= this.song_data.length) {
                track_number = 0;
              } else if (track_number < 0) {
                track_number = this.song_data.length - 1;
              }

              // Stop the current song if it is playing
              if (this.audio && !this.audio.paused) {
                this.stop_song();
              }

              // Play the song
              let song_url = this.song_data[track_number].url;
              this.parent_element.querySelector(".SP-track-name").innerHTML =
                this.song_data[track_number].name;
              this.parent_element.querySelector(".SP-artist-name").innerHTML =
                this.song_data[track_number].artist;
              this.audio = new Audio(song_url);
              this.audio.addEventListener("ended", () => {
                this.audio.currentTime = 0;
                this.next_song();
              });
              this.audio.play();
              this.current_track_index = track_number;
            };

            pause_song = () => {
              this.audio.pause();
            };

            next_song = () => {
              let next_track_number = this.current_track_index + 1;
              if (next_track_number >= this.song_data.length) {
                next_track_number = 0;
              }
              this.audio.pause();
            };

            prev_song = () => {
              let prev_track_number = this.current_track_index - 1;
              if (prev_track_number < 0) {
                prev_track_number = this.song_data.length - 1;
              }

              this.play_song(prev_track_number);
            };

            stop_song = () => {
              this.audio.pause();
              this.audio = null;
              this.current_track_index = -1;
            };

            getSongProgressString = (audio_object) => {
              if (!audio_object) {
                return "0:00";
              }
              const current_time = audio_object.currentTime || 0;
              return `${Math.floor(current_time / 60)}:${Math.floor(
                current_time % 60
              )
                .toString()
                .padStart(2, "0")}`;
            };

            getSongDurationString = (audio_object) => {
              if (!audio_object) {
                return "0:00";
              }
              const duration = audio_object.duration || 0;
              return `${Math.floor(duration / 60)}:${Math.floor(duration % 60)
                .toString()
                .padStart(2, "0")}`;
            };

            updateDurationText = (audio_object) => {
              let progressText =
                this.parent_element.querySelector(".SP-duration-total");
              progressText.innerHTML = this.getSongDurationString(audio_object);
            };

            updateProgressText = (audio_object) => {
              let progressText = this.parent_element.querySelector(
                ".SP-duration-current"
              );
              progressText.innerHTML = this.getSongProgressString(audio_object);
            };

            getSongProgressPercent = (audio_object) => {
              if (audio_object == null) return 0;
              const currentTime = audio_object.currentTime;
              const duration = audio_object.duration;
              return currentTime / duration;
            };

            updateProgressBar = (progressFloat) => {
              let progressTruncated = progressFloat.toFixed(2);
              let progressBar = this.parent_element.querySelector(
                ".SP-progress-bar-fill"
              );
              progressBar.style.width = progressTruncated + "%";
            };

            // This function scrolls the track text in the player when it is too long to fit in the container
            scrollTrackText = () => {
              if (
                this.track_element.scrollWidth >
                  this.track_element.clientWidth +
                    this.track_element.scrollLeft &&
                this.track_scrolling_left
              ) {
                this.track_element.scrollBy(1, 0);
              } else {
                this.track_scrolling_left = false;
              }
              if (!this.track_scrolling_left) {
                this.track_element.scrollBy(-0.5, 0);
                if (this.track_element.scrollLeft === 0) {
                  this.track_scrolling_left = true;
                }
              }
            };

            // This function scrolls the artist text in the player when it is too long to fit in the container
            scrollArtistText = () => {
              if (
                this.artist_element.scrollWidth >
                  this.artist_element.clientWidth +
                    this.artist_element.scrollLeft &&
                this.artist_scrolling_left
              ) {
                this.artist_element.scrollBy(1, 0);
              } else {
                this.artist_scrolling_left = false;
              }
              if (!this.artist_scrolling_left) {
                this.artist_element.scrollBy(-0.5, 0);
                if (this.artist_element.scrollLeft === 0) {
                  this.artist_scrolling_left = true;
                }
              }
            };

            // This hides the play button when the audio is playing and hides the pause button when the audio is paused
            renderPauseOrPlayButton = () => {
              let play_button = this.parent_element.querySelector(".SP-play");
              let pause_button = this.parent_element.querySelector(".SP-pause");
              if (this.audio && !this.audio.paused) {
                play_button.style.display = "none";
                pause_button.style.display = "block";
              } else {
                play_button.style.display = "block";
                pause_button.style.display = "none";
              }
            };
          }
          // Song files hosted on github >🐢
          let song_data_absolute = [
            {
              name: "two of a kind",
              artist: "U.N. Owen Was Her",
              url: "../mp3/what.mp3",
            },
          ];
          // Song files hosted on nekoweb >🐢
          let song_data_relative = [
            {
              name: "two of a kind",
              artist: "U.N. Owen Was Her",
              url: "../mp3/what.mp3",
            },
          ];

          // Automatically initialize all song players on the page with the same data >🐢
          // let song_player_elements = document.querySelectorAll(".StarrPlayer");
          // let audio_players = [];

          // song_player_elements.forEach((element) => {
          //     let audio_player = new MusicPlayer(element, song_data_relative);
          //     audio_players.push(audio_player);
          // });

          // Load the song players manually >🐢
          let song_player_basic = document.querySelector(".StarrPlayer");
          let basic_player = new MusicPlayer(
            song_player_basic,
            song_data_relative
          );

          // This one loads from github via an absolute path >🐢
          let song_player_stone = document.querySelector(
            "#SP-stone.StarrPlayer"
          );
          let stone_player = new MusicPlayer(
            song_player_stone,
            song_data_absolute
          );

          // This one loads from nekoweb via a relative path >🐢
          let song_player_tv = document.querySelector("#SP-tv.StarrPlayer");
          let tv_player = new MusicPlayer(song_player_tv, song_data_relative);
        </script>
      </footer>
      <p class="text-white book-page" style="font-family: 'monospace;'">
        De la nada, se fue la luz y se escuchó cómo el suelo se alzaba para
        separarnos y sellarnos de cada uno a lo largo del pasillo.
      </p>
    </main>
    <div class="text-center">
      <button
        class="btn btn-light mb-5"
        onclick="window.location.href='2.html'"
      >
        volver
      </button>
      <button
        class="btn btn-danger mb-5"
        onclick="window.location.href='../c4/1.html'"
      >
        siguiente
      </button>
    </div>
  </body>
</html>
